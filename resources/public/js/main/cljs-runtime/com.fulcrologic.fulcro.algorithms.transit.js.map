{"version":3,"sources":["com/fulcrologic/fulcro/algorithms/transit.cljc"],"mappings":"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","names":["js/com","js/com.fulcrologic","js/com.fulcrologic.fulcro","js/com.fulcrologic.fulcro.algorithms","js/com.fulcrologic.fulcro.algorithms.transit","js/com.fulcrologic.fulcro.algorithms.transit.transit-handlers","com.fulcrologic.fulcro.algorithms.transit/transit-handlers","cljs.core.atom","com.fulcrologic.fulcro.algorithms.transit/read-handlers","cljs.core/deref","cljs.core.get","com.fulcrologic.fulcro.algorithms.transit/write-handlers","var_args","G__45317","com.fulcrologic.fulcro.algorithms.transit/writer","js/Error","com.fulcrologic.fulcro.algorithms.transit.writer","opts","cognitect.transit.writer","cljs.core.update","cljs.core/merge","G__45320","com.fulcrologic.fulcro.algorithms.transit/reader","com.fulcrologic.fulcro.algorithms.transit.reader","cognitect.transit.reader","com.fulcrologic.fulcro.algorithms.transit/serializable?","v","e45323","e","G__45330","com.fulcrologic.fulcro.algorithms.transit/transit-clj->str","data","com.fulcrologic.fulcro.algorithms.transit.transit_clj__GT_str","write-meta","cognitect.transit/write-meta","G__45335","cljs.core.dissoc","and__5043__auto__","cljs.core.assoc","cognitect.transit/write","G__45339","com.fulcrologic.fulcro.algorithms.transit/transit-str->clj","str","com.fulcrologic.fulcro.algorithms.transit.transit_str__GT_clj","cognitect.transit/read","cljs.spec.alpha/def-impl","cljs.core/map?","cljs.spec.alpha/fspec-impl","cljs.spec.alpha.spec_impl","cljs.spec.alpha/cat-impl","cljs.spec.alpha/map-spec-impl","G__45344","cljs.core/contains?","map__45345","G__45346","cljs.core/--destructure-map","argspec45340","retspec45341","com.fulcrologic.guardrails.core/run-check","f45343","ret45342","com.fulcrologic.fulcro.algorithms.transit/type-handler","type","tag","type->ground","ground->type","cljs.core/any?","cljs.core/string?","cljs.core/fn?","cognitect.transit.write_handler","_","t","r","cognitect.transit/read-handler","G__45351","map__45352","G__45353","retspec45348","argspec45347","f45350","ret45349","com.fulcrologic.fulcro.algorithms.transit/install-type-handler!","cljs.core/nil?","cljs.core.swap_BANG_","m","js/com.fulcrologic.fulcro.algorithms.transit.install-tempid-handler","com.fulcrologic.fulcro.algorithms.transit/install-tempid-handler","com.fulcrologic.fulcro.algorithms.tempid/TempId","com.fulcrologic.fulcro.algorithms.tempid/tag","tid","uuid","com.fulcrologic.fulcro.algorithms.tempid.tempid"],"sourcesContent":["(ns com.fulcrologic.fulcro.algorithms.transit\n  \"Transit functions for the on-the-wire EDN communication to common remotes. Includes support for Fulcro tempids,\n   and can be extended to support additional application-specific data types.\"\n  #?(:clj\n     (:refer-clojure :exclude [ref]))\n  (:require\n    [cognitect.transit :as t]\n    [com.fulcrologic.guardrails.core :refer [>defn =>]]\n    [clojure.spec.alpha :as s]\n    [com.fulcrologic.fulcro.algorithms.tempid :as tempid #?@(:cljs [:refer [TempId]])])\n  #?(:clj\n     (:import [com.cognitect.transit\n               TransitFactory WriteHandler ReadHandler]\n              [com.fulcrologic.fulcro.algorithms.tempid TempId])))\n\n\n(defonce transit-handlers\n  (atom\n    {:writers {}\n     :readers {}}))\n\n(defn read-handlers\n  \"Returns a map that can be used for the :handlers key of a transit reader, taken from the current type handler registry.\"\n  []\n  (get @transit-handlers :readers {}))\n\n(defn write-handlers\n  \"Returns a map that can be used for the :handlers key of a transit writer, taken from the current type handler registry.\"\n  []\n  (get @transit-handlers :writers {}))\n\n\n#?(:cljs\n   (defn writer\n     \"Create a transit writer.\n\n     - `out`: An acceptable output for transit writers.\n     - `opts`: (optional) options to pass to `cognitect.transit/writer` (such as handlers).\"\n     ([] (writer {}))\n     ([opts] (t/writer :json (update opts :handlers merge (write-handlers))))))\n\n#?(:clj\n   (defn writer\n     \"Create a transit writer.\n\n     - `out`: An acceptable output for transit writers.\n     - `opts`: (optional) options to pass to `cognitect.transit/writer` (such as data type handlers).\"\n     ([out] (writer out {}))\n     ([out opts] (t/writer out :json (update opts :handlers merge (write-handlers))))))\n\n#?(:cljs\n   (defn reader\n     \"Create a transit reader.\n\n     - `opts`: (optional) options to pass to `cognitect.transit/reader` (such as data type handlers).\"\n     ([] (reader {}))\n     ([opts] (t/reader :json (update opts :handlers merge (read-handlers))))))\n\n#?(:clj\n   (defn reader\n     \"Create a transit reader.\n\n     - `opts`: (optional) options to pass to `cognitect.transit/reader` (such as data type handlers).\"\n     ([in] (reader in {}))\n     ([in opts] (t/reader in :json (-> opts (update :handlers merge (read-handlers)))))))\n\n(defn serializable?\n  \"Checks to see that the value in question can be serialized by the default fulcro writer by actually attempting to\n  serialize it.  This is *not* an efficient check.\"\n  [v]\n  #?(:clj  (try\n             (.write (writer (java.io.ByteArrayOutputStream.)) v)\n             true\n             (catch Exception e false))\n     :cljs (try\n             (.write (writer) v)\n             true\n             (catch :default e false))))\n\n(defn transit-clj->str\n  \"Use transit to encode clj data as a string. Useful for encoding initial app state from server-side rendering.\n\n  - `data`: Arbitrary data\n  - `opts`: (optional) Options to send when creating a `writer`. Always preserves metadata. Adding :metadata? true/false\n    will turn on/off metadata support. Defaults to on.\"\n  ([data] (transit-clj->str data {}))\n  ([data opts]\n   ;; Support for Datomic Cloud, which uses an older version of transit with no write-meta\n   (let [write-meta #?(:cljs t/write-meta\n                       :clj (resolve `t/write-meta))\n         opts               (cond-> (dissoc opts :metadata?)\n                              (and write-meta (not (false? (:metadata? opts)))) (assoc :transform write-meta))]\n     #?(:cljs (t/write (writer opts) data)\n        :clj\n              (with-open [out (java.io.ByteArrayOutputStream.)]\n                (t/write (writer out opts) data)\n                (.toString out \"UTF-8\"))))))\n\n(defn transit-str->clj\n  \"Use transit to decode a string into a clj data structure. Useful for decoding initial app state\n   when starting from a server-side rendering.\"\n  ([str] (transit-str->clj str {}))\n  ([str opts]\n   #?(:cljs (t/read (reader opts) str)\n      :clj  (t/read (reader (java.io.ByteArrayInputStream. (.getBytes str \"UTF-8\")) opts)))))\n\n(s/def ::reader map?)\n(s/def ::writer map?)\n\n(>defn type-handler\n  \"Creates a map that can be registered with Fulcro's transit support.\n\n   * `type` is a `deftype` or `defrecord` that represents your runtime data that you want to support in Transit\n   * `tag` is a string that uniquely identifies your type on the wire\n   * `type->ground` is a function that can take an instance of your `type` and turn it into something transit already\n   knows how to handle.\n   * `ground->type` is a function that can take whatever `type->ground` generated and turn it back into your `type`.\n\n   This function returns a map that contains a :reader and :writer key. The value at these keys is suitable for merging\n   at the `:handlers` key of a reader or writer's option map.\n\n   See also `install-type-handler!` for adding this to Fulcro's registry of type support.\"\n  [type tag type->ground ground->type]\n  [any? string? fn? fn? => (s/keys :req-un [::reader ::writer])]\n  {:writer {type (t/write-handler\n                   (fn [_] tag)\n                   (fn [t] (type->ground t))\n                   (fn [r] (str tag \"#\" r)))}\n   :reader {tag (t/read-handler ground->type)}})\n\n(>defn install-type-handler!\n  \"Install a type handler (generated by `type-handler`) into the global Fulcro transit support registry. This registry\n   can be used by any Fulcro-aware facility that needs to use transit for any standard purpose where app-specific type\n   support is desired.\"\n  [t]\n  [(s/keys :req-un [::reader ::writer]) => nil?]\n  (swap! transit-handlers (fn [m]\n                            (-> m\n                              (update :readers merge (:reader t))\n                              (update :writers merge (:writer t)))))\n  nil)\n\n(defonce install-tempid-handler\n  (install-type-handler! (type-handler TempId tempid/tag\n                           (fn [^TempId tid] (.-id tid))\n                           (fn [uuid] (tempid/tempid uuid)))))\n"]}